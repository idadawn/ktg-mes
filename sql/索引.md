# KTG-MES SQLè„šæœ¬ç´¢å¼•

## ğŸ“‹ æ¦‚è¿°

æœ¬ç›®å½•åŒ…å«KTG-MESç³»ç»Ÿå®Œæ•´çš„æ•°æ®åº“è„šæœ¬ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–ã€ä¿®å¤ã€å¤‡ä»½ç­‰æ‰€æœ‰SQLç›¸å…³æ–‡ä»¶ã€‚

## ğŸ—‚ï¸ æ–‡ä»¶åˆ†ç±»

### ğŸš€ å¿«é€Ÿå¼€å§‹è„šæœ¬

| æ–‡ä»¶å | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|--------|------|----------|
| `reinit_database.sh` | **ä¸€é”®é‡æ–°åˆå§‹åŒ–** | å®Œæ•´é‡æ–°éƒ¨ç½²æ•°æ®åº“ |
| `init_database.sh` | åŸºç¡€åˆå§‹åŒ–è„šæœ¬ | é¦–æ¬¡éƒ¨ç½² |
| `README.md` | è¯¦ç»†ä½¿ç”¨è¯´æ˜ | å‚è€ƒæ–‡æ¡£ |

### ğŸ—ï¸ æ ¸å¿ƒç³»ç»Ÿè„šæœ¬

| æ–‡ä»¶å | è¯´æ˜ | è¡¨æ•°é‡ | å­—ç¬¦é›† |
|--------|------|--------|--------|
| `ry_20210908.sql` | è‹¥ä¾æ ¸å¿ƒç³»ç»Ÿè¡¨ | 23 | utf8mb4 |
| `quartz.sql` | Quartzå®šæ—¶ä»»åŠ¡è¡¨ | 11 | utf8mb4 |

### ğŸ“Š ä¸šåŠ¡æ¨¡å—è„šæœ¬

| æ–‡ä»¶å | è¯´æ˜ | æ¨¡å— | è¡¨æ•°é‡ |
|--------|------|------|--------|
| `mes-report.sql` | æŠ¥è¡¨æ¨¡å—è¡¨ | æŠ¥è¡¨ | 2 |
| `print_client.sql` | æ‰“å°å®¢æˆ·ç«¯è¡¨ | æ‰“å° | 1 |
| `pro_workorder.sql` | å·¥å•ç›¸å…³è¡¨ | ç”Ÿäº§ | 5 |
| `pro_route_process.sql` | å·¥è‰ºè·¯çº¿è¡¨ | ç”Ÿäº§ | 3 |
| `pro_route_product.sql` | äº§å“å·¥è‰ºè¡¨ | ç”Ÿäº§ | 2 |
| `pro_feedback.sql` | ç”Ÿäº§åé¦ˆè¡¨ | ç”Ÿäº§ | 1 |

### ğŸ”§ ä¿®å¤è„šæœ¬

| æ–‡ä»¶å | è¯´æ˜ | ä¿®å¤å†…å®¹ |
|--------|------|----------|
| `fix_missing_columns_all.sql` | **æ±‡æ€»ä¿®å¤è„šæœ¬** | æ‰€æœ‰ç¼ºå¤±åˆ— |
| `fix_add_unit_name_column.sql` | å·¥å•å•ä½åç§°åˆ— | pro_workorder.unit_name |
| `fix_add_frozen_flag_column.sql` | ä»“åº“å†»ç»“æ ‡è¯†åˆ— | wm_warehouse.frozen_flag |
| `fix_add_charge_id_column.sql` | è½¦é—´è´Ÿè´£äººåˆ— | md_workshop.charge_id |
| `fix_menu_encoding.sql` | èœå•ç¼–ç ä¿®å¤ | sys_menu ä¸­æ–‡ä¹±ç  |

### ğŸ“ å¤‡ä»½ç›®å½•

| ç›®å½• | è¯´æ˜ | æ–‡ä»¶æ ¼å¼ |
|------|------|----------|
| `backups/` | è‡ªåŠ¨å¤‡ä»½æ–‡ä»¶ | ktgmes_backup_YYYYMMDD_HHMMSS.sql |

## ğŸš€ ä½¿ç”¨æŒ‡å—

### æ–¹æ³•ä¸€ï¼šä¸€é”®åˆå§‹åŒ–ï¼ˆæ¨èï¼‰

```bash
cd /home/dawn/project/mes/ktg-mes
bash sql/reinit_database.sh
```

**ç‰¹ç‚¹ï¼š**
- âœ… è‡ªåŠ¨å¤‡ä»½ç°æœ‰æ•°æ®
- âœ… å½©è‰²è¾“å‡ºæ˜¾ç¤ºè¿›åº¦
- âœ… è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—
- âœ… æ¨¡å—åŒ–è¡¨ç»Ÿè®¡
- âœ… é”™è¯¯å¤„ç†å’Œå›æ»š

### æ–¹æ³•äºŒï¼šåˆ†æ­¥æ‰§è¡Œ

```bash
# 1. æ ¸å¿ƒç³»ç»Ÿè¡¨
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes --default-character-set=utf8mb4 < sql/ry_20210908.sql

# 2. Quartzè°ƒåº¦è¡¨
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes --default-character-set=utf8mb4 < sql/quartz.sql

# 3. ä¸šåŠ¡æ¨¡å—è¡¨
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes --default-character-set=utf8mb4 < sql/mes-report.sql
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes --default-character-set=utf8mb4 < sql/print_client.sql

# 4. ä¿®å¤è„šæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes --default-character-set=utf8mb4 < sql/fix_missing_columns_all.sql
```

### æ–¹æ³•ä¸‰ï¼šDocker Composeè‡ªåŠ¨æ‰§è¡Œ

æ•°æ®åº“ä¼šåœ¨å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ `sql/` ç›®å½•ä¸‹çš„æ‰€æœ‰ `.sql` æ–‡ä»¶ã€‚

## ğŸ“Š æ•°æ®åº“ç»Ÿè®¡

### æ€»è§ˆ

- **æ€»è¡¨æ•°**: 176ä¸ª
- **å­—ç¬¦é›†**: UTF-8 (utf8mb4)
- **æ•°æ®åº“å¼•æ“**: InnoDB
- **é»˜è®¤è´¦æˆ·**: admin/admin123

### æ¨¡å—åˆ†å¸ƒ

| æ¨¡å— | è¡¨æ•°é‡ | ä¸»è¦è¡¨ | è¯´æ˜ |
|------|--------|--------|------|
| **ä»“å‚¨æ¨¡å— (wm_*)** | 64 | åº“å­˜ã€å‡ºå…¥åº“ã€ç›˜ç‚¹ç­‰ | æ ¸å¿ƒä¸šåŠ¡æ¨¡å— |
| **ç³»ç»Ÿè¡¨ (sys_*)** | 23 | ç”¨æˆ·ã€è§’è‰²ã€èœå•ã€å­—å…¸ç­‰ | åŸºç¡€ç³»ç»ŸåŠŸèƒ½ |
| **ç”Ÿäº§æ¨¡å— (pro_*)** | 20 | å·¥å•ã€å·¥è‰ºè·¯çº¿ã€æŠ¥å·¥ç­‰ | ç”Ÿäº§ç®¡ç† |
| **è´¨é‡æ¨¡å— (qc_*)** | 16 | è´¨æ£€ã€æ£€éªŒå•ã€ç¼ºé™·ç­‰ | è´¨é‡ç®¡ç† |
| **ä¸»æ•°æ® (md_*)** | 14 | ç‰©æ–™ã€å®¢æˆ·ã€ä¾›åº”å•†ç­‰ | åŸºç¡€æ•°æ® |
| **è®¾å¤‡æ¨¡å— (dv_*)** | 13 | è®¾å¤‡ç®¡ç†ã€ç»´æŠ¤ä¿å…»ç­‰ | è®¾å¤‡ç®¡ç† |
| **Quartz (QRTZ_*)** | 11 | å®šæ—¶ä»»åŠ¡è°ƒåº¦ | ä»»åŠ¡è°ƒåº¦ |
| **æ—¥å†æ¨¡å— (cal_*)** | 7 | å·¥ä½œæ—¥å†ã€ç­æ¬¡ç­‰ | æ—¶é—´ç®¡ç† |
| **æŠ¥è¡¨æ¨¡å— (report_*)** | 2 | å›¾è¡¨ç»„ä»¶ã€è§’è‰²æƒé™ | æŠ¥è¡¨åŠŸèƒ½ |
| **å·¥è£…æ¨¡å— (tm_*)** | 2 | å·¥è£…å¤¹å…·ç®¡ç† | å·¥è£…ç®¡ç† |
| **ä»£ç ç”Ÿæˆ (gen_*)** | 2 | ä»£ç ç”Ÿæˆå™¨ | å¼€å‘å·¥å…· |
| **æ‰“å°æ¨¡å— (print_*)** | 1 | æ‰“å°å®¢æˆ·ç«¯ç®¡ç† | æ‰“å°åŠŸèƒ½ |
| **å…¶ä»–è¡¨** | 1 | æŠ¥è¡¨æ–‡ä»¶å­˜å‚¨ | æ–‡ä»¶ç®¡ç† |

## ğŸ”§ ç»´æŠ¤æ“ä½œ

### æ•°æ®åº“å¤‡ä»½

```bash
# è‡ªåŠ¨å¤‡ä»½ï¼ˆæ¨èï¼‰
bash sql/reinit_database.sh

# æ‰‹åŠ¨å¤‡ä»½
docker exec ktg-mes-mysql mysqldump -uktgmes -pktgmes123 ktgmes > backup_$(date +%Y%m%d_%H%M%S).sql
```

### æ•°æ®åº“æ¢å¤

```bash
# ä»å¤‡ä»½æ–‡ä»¶æ¢å¤
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes < backup_20250930_120000.sql
```

### è¡¨ç»“æ„æ£€æŸ¥

```bash
# æ£€æŸ¥è¡¨æ•°é‡
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes -e "SELECT COUNT(*) as total_tables FROM information_schema.tables WHERE table_schema = 'ktgmes';"

# æ£€æŸ¥å„æ¨¡å—è¡¨æ•°é‡
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes -e "
SELECT 
    CASE 
        WHEN table_name LIKE 'sys_%' THEN 'ç³»ç»Ÿè¡¨(sys_*)'
        WHEN table_name LIKE 'pro_%' THEN 'ç”Ÿäº§æ¨¡å—(pro_*)'
        WHEN table_name LIKE 'wm_%' THEN 'ä»“å‚¨æ¨¡å—(wm_*)'
        WHEN table_name LIKE 'qc_%' THEN 'è´¨é‡æ¨¡å—(qc_*)'
        WHEN table_name LIKE 'report_%' THEN 'æŠ¥è¡¨æ¨¡å—(report_*)'
        ELSE 'å…¶ä»–'
    END as module,
    COUNT(*) as count
FROM information_schema.tables 
WHERE table_schema = 'ktgmes'
GROUP BY module
ORDER BY count DESC;
"
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### å­—ç¬¦ç¼–ç 

**é‡è¦**: æ‰€æœ‰SQLæ–‡ä»¶å‡ä½¿ç”¨ `utf8mb4` å­—ç¬¦é›†ï¼Œç¡®ä¿ä¸­æ–‡å­—ç¬¦æ­£ç¡®æ˜¾ç¤ºã€‚

æ‰§è¡ŒSQLæ—¶å¿…é¡»æŒ‡å®šå­—ç¬¦é›†ï¼š
```bash
--default-character-set=utf8mb4
```

### æ‰§è¡Œé¡ºåº

1. **æ ¸å¿ƒç³»ç»Ÿè¡¨** - ry_20210908.sql, quartz.sql
2. **ä¸šåŠ¡æ¨¡å—è¡¨** - mes-report.sql, print_client.sql
3. **ä¿®å¤è„šæœ¬** - fix_*.sql
4. **æ•°æ®åˆå§‹åŒ–** - é€šè¿‡åº”ç”¨è‡ªåŠ¨æ‰§è¡Œ

### ä¾èµ–å…³ç³»

éƒ¨åˆ†è¡¨ä¹‹é—´å­˜åœ¨å¤–é”®å…³ç³»ï¼Œå¿…é¡»æŒ‰ç…§æ­£ç¡®é¡ºåºæ‰§è¡Œï¼Œå¦åˆ™ä¼šå¯¼è‡´å¤±è´¥ã€‚

## ğŸ› å¸¸è§é—®é¢˜

### 1. ä¸­æ–‡ä¹±ç 

**åŸå› **: æœªæŒ‡å®šå­—ç¬¦é›†
**è§£å†³**: ä½¿ç”¨ `--default-character-set=utf8mb4` å‚æ•°

### 2. è¡¨å·²å­˜åœ¨é”™è¯¯

**åŸå› **: é‡å¤æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
**è§£å†³**: ä½¿ç”¨ `reinit_database.sh` è„šæœ¬ä¼šè‡ªåŠ¨æ¸…ç©ºåé‡æ–°åˆ›å»º

### 3. å¤–é”®çº¦æŸé”™è¯¯

**åŸå› **: æ‰§è¡Œé¡ºåºé”™è¯¯
**è§£å†³**: æŒ‰ç…§ç´¢å¼•ä¸­çš„é¡ºåºæ‰§è¡ŒSQLæ–‡ä»¶

### 4. æƒé™ä¸è¶³

**åŸå› **: æ•°æ®åº“ç”¨æˆ·æƒé™ä¸è¶³
**è§£å†³**: ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç 

## ğŸ“ æ›´æ–°æ—¥å¿—

### 2025-09-30
- âœ… åˆ›å»ºå®Œæ•´çš„SQLè„šæœ¬ç´¢å¼•
- âœ… æ•´ç†æ‰€æœ‰ä¿®å¤è„šæœ¬
- âœ… æ·»åŠ è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜
- âœ… åˆ›å»ºè‡ªåŠ¨åŒ–åˆå§‹åŒ–è„šæœ¬

### 2025-10-01
- âœ… å®Œå–„æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
- âœ… æ·»åŠ å¤‡ä»½å’Œæ¢å¤è¯´æ˜
- âœ… ä¼˜åŒ–è„šæœ¬æ‰§è¡Œé¡ºåº
- âœ… æ·»åŠ æ•…éšœæ’é™¤æŒ‡å—

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- é¡¹ç›®æ–‡æ¡£: `/doc`
- æ•°æ®åº“è®¾è®¡æ–‡æ¡£: `/doc/è®¾è®¡æ–‡æ¡£/æ•°æ®åº“è®¾è®¡/`
- ç³»ç»Ÿæƒé™æ¸…å•: `/doc/å®æ–½æ–‡æ¡£/`

---

**æœ€åæ›´æ–°**: 2025-09-30  
**ç»´æŠ¤è€…**: KTG-MESå¼€å‘å›¢é˜Ÿ  
**ç‰ˆæœ¬**: v1.0.0
