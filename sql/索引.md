# KTG-MES SQL脚本索引

## 📋 概述

本目录包含KTG-MES系统完整的数据库脚本，包括初始化、修复、备份等所有SQL相关文件。

## 🗂️ 文件分类

### 🚀 快速开始脚本

| 文件名 | 说明 | 使用场景 |
|--------|------|----------|
| `reinit_database.sh` | **一键重新初始化** | 完整重新部署数据库 |
| `init_database.sh` | 基础初始化脚本 | 首次部署 |
| `README.md` | 详细使用说明 | 参考文档 |

### 🏗️ 核心系统脚本

| 文件名 | 说明 | 表数量 | 字符集 |
|--------|------|--------|--------|
| `ry_20210908.sql` | 若依核心系统表 | 23 | utf8mb4 |
| `quartz.sql` | Quartz定时任务表 | 11 | utf8mb4 |

### 📊 业务模块脚本

| 文件名 | 说明 | 模块 | 表数量 |
|--------|------|------|--------|
| `mes-report.sql` | 报表模块表 | 报表 | 2 |
| `print_client.sql` | 打印客户端表 | 打印 | 1 |
| `pro_workorder.sql` | 工单相关表 | 生产 | 5 |
| `pro_route_process.sql` | 工艺路线表 | 生产 | 3 |
| `pro_route_product.sql` | 产品工艺表 | 生产 | 2 |
| `pro_feedback.sql` | 生产反馈表 | 生产 | 1 |

### 🔧 修复脚本

| 文件名 | 说明 | 修复内容 |
|--------|------|----------|
| `fix_missing_columns_all.sql` | **汇总修复脚本** | 所有缺失列 |
| `fix_add_unit_name_column.sql` | 工单单位名称列 | pro_workorder.unit_name |
| `fix_add_frozen_flag_column.sql` | 仓库冻结标识列 | wm_warehouse.frozen_flag |
| `fix_add_charge_id_column.sql` | 车间负责人列 | md_workshop.charge_id |
| `fix_menu_encoding.sql` | 菜单编码修复 | sys_menu 中文乱码 |

### 📁 备份目录

| 目录 | 说明 | 文件格式 |
|------|------|----------|
| `backups/` | 自动备份文件 | ktgmes_backup_YYYYMMDD_HHMMSS.sql |

## 🚀 使用指南

### 方法一：一键初始化（推荐）

```bash
cd /home/dawn/project/mes/ktg-mes
bash sql/reinit_database.sh
```

**特点：**
- ✅ 自动备份现有数据
- ✅ 彩色输出显示进度
- ✅ 详细的执行日志
- ✅ 模块化表统计
- ✅ 错误处理和回滚

### 方法二：分步执行

```bash
# 1. 核心系统表
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes --default-character-set=utf8mb4 < sql/ry_20210908.sql

# 2. Quartz调度表
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes --default-character-set=utf8mb4 < sql/quartz.sql

# 3. 业务模块表
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes --default-character-set=utf8mb4 < sql/mes-report.sql
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes --default-character-set=utf8mb4 < sql/print_client.sql

# 4. 修复脚本（如果需要）
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes --default-character-set=utf8mb4 < sql/fix_missing_columns_all.sql
```

### 方法三：Docker Compose自动执行

数据库会在容器启动时自动执行 `sql/` 目录下的所有 `.sql` 文件。

## 📊 数据库统计

### 总览

- **总表数**: 176个
- **字符集**: UTF-8 (utf8mb4)
- **数据库引擎**: InnoDB
- **默认账户**: admin/admin123

### 模块分布

| 模块 | 表数量 | 主要表 | 说明 |
|------|--------|--------|------|
| **仓储模块 (wm_*)** | 64 | 库存、出入库、盘点等 | 核心业务模块 |
| **系统表 (sys_*)** | 23 | 用户、角色、菜单、字典等 | 基础系统功能 |
| **生产模块 (pro_*)** | 20 | 工单、工艺路线、报工等 | 生产管理 |
| **质量模块 (qc_*)** | 16 | 质检、检验单、缺陷等 | 质量管理 |
| **主数据 (md_*)** | 14 | 物料、客户、供应商等 | 基础数据 |
| **设备模块 (dv_*)** | 13 | 设备管理、维护保养等 | 设备管理 |
| **Quartz (QRTZ_*)** | 11 | 定时任务调度 | 任务调度 |
| **日历模块 (cal_*)** | 7 | 工作日历、班次等 | 时间管理 |
| **报表模块 (report_*)** | 2 | 图表组件、角色权限 | 报表功能 |
| **工装模块 (tm_*)** | 2 | 工装夹具管理 | 工装管理 |
| **代码生成 (gen_*)** | 2 | 代码生成器 | 开发工具 |
| **打印模块 (print_*)** | 1 | 打印客户端管理 | 打印功能 |
| **其他表** | 1 | 报表文件存储 | 文件管理 |

## 🔧 维护操作

### 数据库备份

```bash
# 自动备份（推荐）
bash sql/reinit_database.sh

# 手动备份
docker exec ktg-mes-mysql mysqldump -uktgmes -pktgmes123 ktgmes > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 数据库恢复

```bash
# 从备份文件恢复
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes < backup_20250930_120000.sql
```

### 表结构检查

```bash
# 检查表数量
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes -e "SELECT COUNT(*) as total_tables FROM information_schema.tables WHERE table_schema = 'ktgmes';"

# 检查各模块表数量
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes -e "
SELECT 
    CASE 
        WHEN table_name LIKE 'sys_%' THEN '系统表(sys_*)'
        WHEN table_name LIKE 'pro_%' THEN '生产模块(pro_*)'
        WHEN table_name LIKE 'wm_%' THEN '仓储模块(wm_*)'
        WHEN table_name LIKE 'qc_%' THEN '质量模块(qc_*)'
        WHEN table_name LIKE 'report_%' THEN '报表模块(report_*)'
        ELSE '其他'
    END as module,
    COUNT(*) as count
FROM information_schema.tables 
WHERE table_schema = 'ktgmes'
GROUP BY module
ORDER BY count DESC;
"
```

## ⚠️ 注意事项

### 字符编码

**重要**: 所有SQL文件均使用 `utf8mb4` 字符集，确保中文字符正确显示。

执行SQL时必须指定字符集：
```bash
--default-character-set=utf8mb4
```

### 执行顺序

1. **核心系统表** - ry_20210908.sql, quartz.sql
2. **业务模块表** - mes-report.sql, print_client.sql
3. **修复脚本** - fix_*.sql
4. **数据初始化** - 通过应用自动执行

### 依赖关系

部分表之间存在外键关系，必须按照正确顺序执行，否则会导致失败。

## 🐛 常见问题

### 1. 中文乱码

**原因**: 未指定字符集
**解决**: 使用 `--default-character-set=utf8mb4` 参数

### 2. 表已存在错误

**原因**: 重复执行初始化脚本
**解决**: 使用 `reinit_database.sh` 脚本会自动清空后重新创建

### 3. 外键约束错误

**原因**: 执行顺序错误
**解决**: 按照索引中的顺序执行SQL文件

### 4. 权限不足

**原因**: 数据库用户权限不足
**解决**: 确保使用正确的用户名和密码

## 📝 更新日志

### 2025-09-30
- ✅ 创建完整的SQL脚本索引
- ✅ 整理所有修复脚本
- ✅ 添加详细的使用说明
- ✅ 创建自动化初始化脚本

### 2025-10-01
- ✅ 完善数据库统计信息
- ✅ 添加备份和恢复说明
- ✅ 优化脚本执行顺序
- ✅ 添加故障排除指南

## 📞 技术支持

如有问题，请参考：
- 项目文档: `/doc`
- 数据库设计文档: `/doc/设计文档/数据库设计/`
- 系统权限清单: `/doc/实施文档/`

---

**最后更新**: 2025-09-30  
**维护者**: KTG-MES开发团队  
**版本**: v1.0.0
