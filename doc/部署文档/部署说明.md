# KTG-MES 部署说明

## 🚀 一键部署

### 环境要求

- Docker 20.10+
- Docker Compose 1.29+
- 至少 4GB 可用内存
- 至少 10GB 可用磁盘空间

### 快速开始

```bash
# 1. 克隆项目
git clone https://gitee.com/kutangguo/ktg-mes.git
cd ktg-mes

# 2. 启动所有服务
docker-compose up -d

# 3. 查看服务状态
docker-compose ps

# 4. 查看启动日志
docker-compose logs -f
```

### 等待服务启动

首次启动需要等待以下服务完全启动：

1. **MySQL数据库** (约30秒) - 自动创建数据库和表
2. **Redis缓存** (约10秒) - 启动缓存服务
3. **MinIO存储** (约15秒) - 启动对象存储
4. **前端构建** (约2-3分钟) - 编译前端代码
5. **后端应用** (约1-2分钟) - 启动Spring Boot应用
6. **Nginx代理** (约5秒) - 启动Web服务器

**总启动时间**: 约5-8分钟

## 📍 访问地址

| 服务 | 地址 | 用户名 | 密码 | 说明 |
|------|------|--------|------|------|
| **前端访问** | http://localhost:8000 | admin | admin123 | 主系统界面 |
| **后端API** | http://localhost:8007 | - | - | API接口 |
| **数据库管理** | localhost:8001 | ktgmes | ktgmes123 | MySQL数据库 |
| **Redis管理** | localhost:8002 | - | - | Redis缓存 |
| **MinIO管理** | http://localhost:8004 | minioadmin | minioadmin123 | 对象存储 |
| **RabbitMQ管理** | http://localhost:8006 | admin | admin123 | 消息队列 |
| **Druid监控** | http://localhost:8000/druid/ | admin | 123456 | 数据库连接池监控 |

## 🔧 服务管理

### 查看服务状态

```bash
# 查看所有服务状态
docker-compose ps

# 查看特定服务日志
docker-compose logs -f ktg-mes-app
docker-compose logs -f ktg-mes-ui-builder
docker-compose logs -f mysql
```

### 重启服务

```bash
# 重启所有服务
docker-compose restart

# 重启特定服务
docker-compose restart ktg-mes-app
docker-compose restart ktg-mes-ui-builder
```

### 停止服务

```bash
# 停止所有服务（保留数据）
docker-compose down

# 停止并删除所有数据
docker-compose down -v
```

## 🗄️ 数据库管理

### 数据库初始化

数据库会在首次启动时自动初始化，包含：

- **176个数据表** - 完整的MES业务表结构
- **系统数据** - 用户、角色、菜单、权限等
- **业务数据** - 主数据、生产、质量、仓储等模块
- **默认账户** - admin/admin123

### 手动重新初始化

```bash
# 使用自动化脚本（推荐）
bash sql/reinit_database.sh

# 或手动执行
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes < sql/ry_20210908.sql
```

### 数据库备份

```bash
# 备份数据库
docker exec ktg-mes-mysql mysqldump -uktgmes -pktgmes123 ktgmes > backup_$(date +%Y%m%d_%H%M%S).sql

# 恢复数据库
docker exec -i ktg-mes-mysql mysql -uktgmes -pktgmes123 ktgmes < backup_20250930_120000.sql
```

## 🔍 故障排除

### 1. 端口冲突

如果端口被占用，修改 `docker-compose.yml` 中的端口映射：

```yaml
ports:
  - "8000:80"  # 改为其他端口，如 "8080:80"
```

### 2. 内存不足

如果内存不足，可以：

```bash
# 减少服务数量（移除RabbitMQ）
docker-compose up -d mysql redis minio nginx ktg-mes-ui-builder ktg-mes-app

# 或调整JVM参数
# 编辑 docker-compose.yml 中的 command 部分
```

### 3. 数据库连接失败

```bash
# 检查MySQL状态
docker-compose logs mysql

# 检查数据库是否创建
docker exec -it ktg-mes-mysql mysql -uktgmes -pktgmes123 -e "SHOW DATABASES;"
```

### 4. 前端构建失败

```bash
# 查看构建日志
docker-compose logs ktg-mes-ui-builder

# 手动重新构建
docker-compose restart ktg-mes-ui-builder
```

### 5. 应用启动失败

```bash
# 查看应用日志
docker-compose logs ktg-mes-app

# 检查配置文件
docker exec -it ktg-mes-app cat /app/config/application-prod.yml
```

## 📊 性能优化

### 生产环境建议

1. **增加内存**: 建议至少8GB内存
2. **SSD存储**: 使用SSD提高数据库性能
3. **网络优化**: 使用千兆网络
4. **定期备份**: 设置自动备份策略

### 监控配置

1. **启用Druid监控**: 访问 http://localhost:8000/druid/
2. **查看系统日志**: `docker-compose logs -f`
3. **监控资源使用**: `docker stats`

## 🔒 安全配置

### 修改默认密码

1. **数据库密码**: 修改 `docker-compose.yml` 中的 `MYSQL_PASSWORD`
2. **应用密码**: 修改 `config/application-prod.yml` 中的数据库配置
3. **MinIO密码**: 修改 `docker-compose.yml` 中的 `MINIO_ROOT_PASSWORD`
4. **系统账户**: 登录系统后修改admin密码

### 网络安全

1. **防火墙配置**: 只开放必要端口
2. **HTTPS配置**: 配置SSL证书
3. **访问控制**: 设置IP白名单

## 📝 维护建议

### 日常维护

1. **定期备份**: 每日备份数据库
2. **日志清理**: 定期清理应用日志
3. **监控检查**: 定期检查服务状态
4. **更新升级**: 定期更新Docker镜像

### 故障预防

1. **资源监控**: 监控CPU、内存、磁盘使用率
2. **日志分析**: 定期分析错误日志
3. **性能测试**: 定期进行压力测试
4. **备份验证**: 定期验证备份文件完整性

---

**最后更新**: 2025-09-30  
**维护者**: KTG-MES开发团队
