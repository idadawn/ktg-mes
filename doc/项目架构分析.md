# KTG-MES 项目架构分析文档

## 项目概述

KTG-MES（苦糖果制造执行系统）是一款基于Spring Boot的B/S结构、开源、免费的生产执行管理系统，专门为离散制造业的中小企业提供专业化的MES解决方案。

## 技术架构

### 1. 技术栈

#### 后端技术
- **核心框架**: Spring Boot 2.5.12
- **ORM框架**: MyBatis + PageHelper分页插件
- **安全认证**: JWT Token
- **数据库连接池**: Druid
- **缓存**: Redis
- **消息队列**: RabbitMQ（可选）
- **报表引擎**: UReport
- **文件存储**: MinIO
- **构建工具**: Maven 3+
- **Java版本**: JDK 1.8

#### 前端技术
- **前端框架**: Vue.js（分离项目）
- **移动端**: Uniapp（触控屏端、Android端）
- **UI组件**: Element UI

#### 数据库
- **主数据库**: MySQL
- **缓存数据库**: Redis

### 2. 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                       前端层                                │
├─────────────────────────────────────────────────────────────┤
│  PC端(Vue)    Android端(Uniapp)   触控屏端(Uniapp)    PDA端  │
└─────────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────────┐
│                       网关层                                │
├─────────────────────────────────────────────────────────────┤
│                    Nginx反向代理                            │
└─────────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────────┐
│                       应用层                                │
├─────────────────────────────────────────────────────────────┤
│                  Spring Boot应用服务                        │
└─────────────────────────────────────────────────────────────┘
                               │
┌─────────────┬─────────────┬─────────────┬───────────────────┐
│   缓存层    │  消息队列   │  文件存储   │     数据层        │
├─────────────┼─────────────┼─────────────┼───────────────────┤
│   Redis     │  RabbitMQ   │   MinIO     │     MySQL        │
└─────────────┴─────────────┴─────────────┴───────────────────┘
```

## 模块化架构

### 1. 核心框架模块

#### ktg-admin（主启动模块）
- **位置**: `ktg-admin/src/main/java/com/ktg/RuoYiApplication.java`
- **功能**: Spring Boot启动类，系统入口
- **特性**:
  - 集成UReport报表引擎
  - 配置热部署
  - 多环境配置支持

#### ktg-framework（框架核心模块）
- **安全认证**: JWT Token认证、权限控制
- **配置管理**: 数据源配置、Redis配置、安全配置
- **AOP切面**: 日志记录、数据权限、限流控制
- **WebSocket**: 实时通信支持
- **异步处理**: 异步任务管理

#### ktg-common（通用工具模块）
- **工具类**: 字符串处理、日期工具、文件操作
- **常量定义**: 系统常量、枚举类型
- **异常处理**: 全局异常处理、业务异常
- **Excel操作**: 导入导出工具
- **验证工具**: 参数验证、数据校验

#### ktg-system（系统管理模块）
- **用户管理**: 用户CRUD、权限分配
- **角色管理**: 角色定义、权限配置
- **菜单管理**: 菜单配置、权限控制
- **字典管理**: 数据字典维护
- **系统监控**: 操作日志、登录日志

### 2. 业务功能模块

#### ktg-mes（MES核心业务模块）

##### cal（日历排班管理）
- **功能**: 节假日设置、排班日历、班次管理
- **控制器**: `CalCalendarController`, `CalHolidayController`, `CalShiftController`
- **领域对象**: `CalCalendar`, `CalHoliday`, `CalShift`

##### dv（设备管理）
- **功能**: 设备台账、设备维护、设备状态监控
- **控制器**: `DvController`及相关移动端控制器
- **特性**: 支持移动端设备管理

##### md（主数据管理）
- **功能**: 物料产品管理、工作站设置、基础数据维护
- **控制器**: `MdController`及相关移动端控制器
- **数据模型**: 物料、产品、工作站等主数据

##### pro（生产管理）
- **功能**: 生产排产、工单管理、工序管理
- **控制器**: `ProController`及相关移动端控制器
- **视图对象**: 生产相关的VO对象

##### qc（质量管理）
- **功能**: 质量检测、不良品管理、质量统计
- **控制器**: `QcController`及相关移动端控制器
- **特性**: 支持移动端质量检验

##### tm（时间管理）
- **功能**: 工时统计、时间跟踪
- **控制器**: `TmController`
- **数据模型**: 时间相关的业务对象

##### wm（仓储管理）
- **功能**: 库存管理、条码管理、出入库管理
- **控制器**: `WmController`及相关移动端控制器
- **工具类**: 仓储相关工具
- **事务处理**: 库存交易处理

##### report（报表统计）
- **功能**: 生产报表、质量报表、设备报表
- **控制器**: `ReportController`
- **提供者**: 报表数据提供者
- **工具类**: 报表生成工具

#### 其他业务模块

##### ktg-quartz（定时任务模块）
- **功能**: 定时任务调度、任务管理
- **集成**: Spring Quartz集成

##### ktg-generator（代码生成器）
- **功能**: 自动代码生成、模板配置
- **技术**: Velocity模板引擎

##### ktg-print（打印模块）
- **功能**: 标签打印、报表打印
- **集成**: 条码打印支持

## 数据库设计

### 数据库模块划分

根据SQL文件分析，数据库按业务模块划分：

- **mes-cal.sql**: 日历排班相关表
- **mes-dv.sql**: 设备管理相关表
- **mes-md.sql**: 主数据相关表
- **mes-pro.sql**: 生产管理相关表
- **mes-qc.sql**: 质量管理相关表
- **mes-tm.sql**: 时间管理相关表
- **mes-wm.sql**: 仓储管理相关表
- **mes_sys.sql**: 系统管理相关表

### 核心表结构特点

- 统一的ID生成策略
- 审计字段（创建人、创建时间、更新人、更新时间）
- 逻辑删除支持
- 数据字典关联
- 多租户支持设计

## 配置架构

### 应用配置（application.yml）

#### 服务器配置
- **端口**: 8080
- **线程池**: 最大800线程，最小100空闲线程
- **文件上传**: 支持10MB单文件，20MB总请求

#### 缓存配置
- **Redis**: 本地6379端口，8连接池
- **Token**: JWT认证，30分钟有效期

#### 业务配置
- **文件存储路径**: 支持Windows/Linux路径
- **验证码类型**: 数学计算/字符验证
- **演示模式开关**: 支持演示环境
- **XSS防护**: 启用XSS过滤

#### 第三方服务
- **MinIO**: 对象存储服务
- **RabbitMQ**: 消息队列（可选）
- **UReport**: 报表引擎

## 部署架构

### 环境要求
- **操作系统**: Windows/Linux
- **Java环境**: JDK 1.8+
- **数据库**: MySQL 5.7+
- **缓存**: Redis 5.0+
- **Web服务器**: Nginx（推荐）

### 部署结构
```
部署目录/
├── ktg-mes.jar          # 应用jar包
├── config/
│   ├── application.yml   # 应用配置
│   └── logback.xml       # 日志配置
├── upload/               # 文件上传目录
├── logs/                 # 日志目录
└── static/               # 静态资源
```

### 集群部署
- 支持多实例部署
- Redis集群缓存
- Nginx负载均衡
- 数据库主从复制

## 安全架构

### 认证授权
- **JWT Token认证**: 无状态认证
- **权限控制**: 基于角色的访问控制(RBAC)
- **数据权限**: 部门数据隔离
- **接口安全**: XSS防护、SQL注入防护

### 审计日志
- **操作日志**: 记录用户操作
- **登录日志**: 记录登录信息
- **系统日志**: 应用运行日志

## 扩展性设计

### 模块化扩展
- 清晰的模块边界
- 标准化的接口定义
- 插件化架构设计

### 业务扩展
- 代码生成器支持快速开发
- 可配置的业务流程
- 灵活的数据字典

### 技术扩展
- 多数据源支持
- 消息队列集成
- 微服务架构准备

## 性能优化

### 数据库优化
- Druid连接池监控
- 分页查询优化
- 索引优化

### 缓存策略
- Redis缓存热点数据
- 多级缓存设计
- 缓存失效策略

### 应用优化
- 异步处理耗时操作
- 连接池配置优化
- 静态资源CDN加速

## 总结

KTG-MES采用现代化的微服务架构设计，具有以下优势：

1. **技术先进**: 基于Spring Boot生态，技术栈成熟稳定
2. **架构清晰**: 模块化设计，职责分离明确
3. **扩展性强**: 支持多端访问，业务模块可独立扩展
4. **安全性高**: 完整的认证授权体系，数据安全有保障
5. **部署灵活**: 支持单机和集群部署，适应不同规模企业
6. **维护方便**: 完善的监控日志，便于运维管理

该系统为制造业企业提供了完整的MES解决方案，覆盖从主数据管理到生产执行的全业务流程。

---

*文档生成时间: 2025-09-30*
*基于项目版本: 3.8.2*